## 今日完成
- 将 `/chat/stream` 升级为 **SSE（Server-Sent Events）** 标准流式输出：响应 `Content-Type` 为 `text/event-stream`
- 新增 `src/app/core/sse.py`：
  - 封装 `sse_event(event, data)`，统一生成 `event:` + `data:` + 空行的 SSE frame
  - `data` 非字符串时自动做 JSON 序列化（确保 SSE data 必须是字符串）
- 改造流式路由 `POST /chat/stream`：
  - 先发送 `event: meta`（包含 `trace_id` 与 `provider`）
  - 逐 token 发送 `event: token`
  - 正常结束发送 `event: done`（`[DONE]`）
  - 异常发送 `event: error`（携带 `trace_id` 便于排障）
- 验收：
  - mock SSE 输出：`meta -> token... -> done`
  - ollama SSE 输出：`meta -> token... -> done`
- 新增回归测试 `tests/test_stream_sse.py`：
  - 使用 `TestClient.stream` 请求 `/chat/stream`
  - 断言响应头 `content-type` 以 `text/event-stream` 开头
  - 断言至少包含 `event: token` 且最终能收到 `event: done`
- 全量测试通过：`pytest -q` 显示 3 个用例全部通过

## 今日卡点
- 流式输出格式从“纯文本”升级为 SSE 后，需要确保客户端能正确解析：
  - 关键点：每个事件块必须以空行结尾（`\n\n`）
  - `data` 必须是字符串，结构化信息要 JSON 序列化后再发送
- mock 流式目前按“字符级”输出 token（可用但不够像真实模型）
  - 后续可优化为按“词/句”级别输出，便于前端显示与测试

## 明日计划（不超过3条）
- 将 `/chat/stream` 的输出进一步“产品化”：
  - 增加 `event: done` 时附带 `usage/metadata`（如 provider/model/耗时等）
  - 统一 `error` 事件格式，前端可稳定消费
- 增强可观测性：日志中打印 `trace_id + provider + model + latency`
- 补 1-2 个测试：覆盖 `provider=ollama` 的失败分支（例如 base_url 不可达时返回 error 事件）

## 面试自测要点（要点式）
1) 为什么要用 SSE，而不是返回一整段文本？
   - SSE 支持服务端持续推送事件，客户端边接收边渲染；更贴近 ChatGPT 的交互体验
2) SSE 一条事件的格式是什么？
   - `event: <type>\n` + `data: <payload>\n\n`；空行是事件分隔符
3) 你定义了哪些事件类型？各自意义是什么？
   - `meta`：链路信息（trace_id/provider）便于前端初始化与排障
   - `token`：增量输出
   - `done`：结束信号
   - `error`：错误信号（携带 trace_id）
4) 测试里为什么要断言 `content-type`？
   - 确认服务端确实按 SSE 协议返回；否则前端无法按事件流解析
5) SSE 的错误处理为什么也要带 trace_id？
   - 线上定位依赖 trace_id 把前端错误与服务端日志对齐，是最小可观测性闭环

## 今日验收命令（备忘）
- mock SSE：
  - `curl -N -X POST http://localhost:8000/chat/stream -H "Content-Type: application/json" -d '{"provider":"mock","messages":[{"role":"user","content":"hi"}],"max_tokens":64}'`
- ollama SSE：
  - `curl -N -X POST http://localhost:8000/chat/stream -H "Content-Type: application/json" -d '{"provider":"ollama","messages":[{"role":"user","content":"一句话解释RAG"}],"max_tokens":64}'`
- 跑测试：
  - `pytest -q`
